\documentclass[a4j,10pt]{jsarticle}
\usepackage{mylatex}
\usepackage{listings,jlisting}
\usepackage[dvipdfmx]{graphicx}
\usepackage{subcaption}
\usepackage{here}
\usepackage{indentfirst}
\graphicspath{ {figures/} }

\title{プロジェクト実習P PHP演習}
\author{C0116023 飯島貴政}
\date{2012年4月27日(金)}

\begin{document}
\maketitle


\section{目的}

現代のWebアプリケーションプログラムは,Webブラウザ上で動作するクライアントプログラ
ム,サーバ側で動作するサーバプログラム,および,データベースアクセスのためのクエリから
構成されることが多い.ここでは,サーバプログラムを記述するためのスクリプティング言語で
ある,PHPについて習得する.

\lstset{
    language = PHP,
    %枠外に行った時の自動改行
    breaklines = true,
    %自動改行後のインデント量(デフォルトでは20[pt])
    breakindent = 10pt,
    %標準の書体
    basicstyle = \ttfamily\scriptsize,
    %関数名等の色の設定
    classoffset = 0,
    %枠 “t”は上に線を記載, “T”は上に二重線を記載
    %他オプション：leftline,topline,bottomline,lines,single,shadowbox
    frame = TBrl,
    %frameまでの間隔(行番号とプログラムの間)
    framesep = 5pt,
    %行番号の位置
    numbers = left,
    %行番号の間隔
    stepnumber = 1,
    %行番号の書体
    numberstyle = \tiny,
    %タブの大きさ
    tabsize = 4,
    %キャプションの場所(“tb”ならば上下両方に記載)
    captionpos = t
}
%=================================================================================

\section{課題1}

\subsection{問題}

文字列「Hello World」をブラウザ上に表示するプログラムphp1.phpを作成せよ.
以降の課題はHTMLにPHPプログラムを埋め込むことによって構成すること.HTMLは5に準拠すること.


\subsection{ソースコード}
ソースコード1のソース8行目でHTML5に準拠させるためhtml lang及び,5行目で文字エンコードを設定している.
ソース8行目でPHPのechoにより {\tt Hello World }という文字列を出力している.

\lstinputlisting[caption=PHP1.php,label=pg:k1-1s]{src/php1.php}
\subsection{実行結果}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics{1.png}
  }
  \caption{ソースコード１の実行結果}
  \label{fig:1}
\end{figure}
\figref{fig:1}はphp1.phpページを開いた時の初期画面である.正常にHello Worldが出力できている.

%=================================================================================

\section{課題2}
\subsection{問題}


  配列にある住所録を表示する関数print\_table(\$addresses)を含むプログラムphp2.php作成せよ.
  このとき\$addressesは住所録を保持する配列であるとする.これは,1名分のデータを保持する連想配列を,要素として人数分含む二重配列構造を持つ.
  1名分のデータを保持する連想配列はインデックスとしてname/address/phone/emailを持つものとする.



\subsection{ソースコード}

ソースコード2のソース11行目から14行目でサンプルの2人分のデータを\$addressesという変数に連想配列で格納した.
18行目でtableタグを宣言し,表を描画する準備をする.24行目でデータの見出しを表示している.29行目でforeachを繰り返しデータの内容をキーごとに出力している.
\lstinputlisting[caption=PHP2.php,label=pg:k2-1s]{src/php2.php}

\subsection{実行結果}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=10cm]{2.png}
  }
  \caption{ソースコード2の実行結果}
  \label{fig:2}
\end{figure}
\figref{fig:2}はphp2.phpページを開いた時の初期画面である.正常に住所録表が出力できている。

%=================================================================================

\section{課題3}

\subsection{問題}

POSTメソッドを使用して,住所録に項目を追加するプログラムphp3.phpを作成せよ.
住所録のデータは保存されず,読み込みのたびに初期状態に戻ってよい.

\subsection{ソースコード}


ソースコード3のソース13行目から17行目でサンプルの2人分のデータを\$addressesという変数に連想配列で格納した.
19行目から送信ボタンが押された際の動作を定義している. \$getPostという変数にフォームから送られたデータを\$\_POSTで取得し,連想配列に格納している.
23行目のarray\_pushの第１引数をデータが追加される連想配列\$addresses,第２引数を追加するデータである\$getPostにすることで,住所録に新しいデータを追加することができる.
57行目から実際にwebページに表示するフォームを設定している. メソッドはPOSTである.
各フォームのnameタグはPHP側の連想配列\$addressesに対応するようにした.


\lstinputlisting[caption=PHP3.php,label=pg:k2-1s]{src/php3.php}

\subsection{実行結果}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=10cm]{3.png}
  }
  \caption{ソースコード3の実行結果[1]}
\label{fig:fig3}
\end{figure}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=10cm]{4.png}
  }
  \caption{ソースコード3の実行結果[2]}
\label{fig:fig4}
\end{figure}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=10cm]{5.png}
  }
  \caption{ソースコード3の実行結果[3]}
\label{fig:fig5}
\end{figure}

\figref{fig:fig3}はphp3.phpページを開いた時の初期画面である.
\figref{fig:fig4}は入力フォームに追加したいデータを入力している.
\figref{fig:fig5}は送信ボタンを押した後,表に新規データが追加されていることが確認できた.
%=================================================================================

\section{課題4}

\subsection{問題}


php3.phpにおいて,データが追加された際に住所録の内容をJSON形式を用いて表示するよ
うにせよ.
(JSON形式による配列の表示は,デバッグの手段としても有効である)

\subsection{ソースコード}

ソースコード4のソース1行目から53行目までは前節のphp3.phpと同コードである. PHP関数を<head>部分に移動した.
55行目では変数 \$json に \$addresses の内容を書き込むjson\_encode関数を記述した. 第１引数は書き込む対象の連想配列,
第２引数はエンコードだが,今回第２引数をUTF-8に指定して,プログラムを実行したところjsonファイルが日本語ではなくなってしまったのでエスケープ文字に変換しないJSON\_UNESCAPED\_UNICODE とした.
56行目file\_put\_contents関数で \$jsonの内容を addresses.json に書き出すようにした. またjsonの内容を表示するためprint(\$json)としている.

\lstinputlisting[caption=PHP4.php,label=pg:k4-1s]{src/php4.php}
\subsection{実行結果}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=10cm]{5.png}
  }
  \caption{ソースコード4の実行結果[1]}
\label{fig:fig6}
\end{figure}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=10cm]{4.png}
  }
  \caption{ソースコード4の実行結果[2]}
\label{fig:fig7}
\end{figure}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=10cm]{6.png}
  }
  \caption{ソースコード4の実行結果[3]}
\label{fig:fig8}
\end{figure}

\figref{fig:fig6}はphp4.phpページを開いた時の初期画面である.
\figref{fig:fig7}は入力フォームに追加したいデータを入力している.
\figref{fig:fig8}は送信ボタンを押した後,表に新規データが追加されていること及びjsonが表示されていることが確認できた.
%=================================================================================
\section{課題5}

\subsection{問題}

  php3.phpで作成した住所録の内容を,addresses.jsonというファイルに書き込み,永続的に
  保存できるようにせよ.
  新しいデータを「追加」ボタンで追加した内容はファイルに保存され,後に画面を参照した
  場合には更新された画面が見えるようにせよ.

\subsection{ソースコード}

ソースコード5のソース7行目から12行目までにjsonを書き込むユーザー定義関数makeJsonを作成した.これはjsonを書き込むことは多々あると考えられるため,関数として呼び出しやすくするべきだと考えたためである.
21行目では変数 \$jsonUrl に 読み込むファイルであるaddresses.jsonを格納している.22行目で \$jsonUrl にjsonファイルがあるかどうかを判断する.
もしある場合は23行目でjsonを読み込んだことをユーザーに知らせるためにWEBページにfile readという表示が出るようにした.24行目では file\_get\_contentsメソッドでjsonの内容を開き\$jsonという変数に格納する.
26行目では \$obj　という変数に json\_encodeメソッドで連想配列にデコードされたaddresses.jsonを代入する.
もしjsonファイルがない場合は30行目の"データがありません" という文字がWEBページに表示される.
32行目から36行目までは前節と共通のコードである.37行目のmakeJson(\$obj)は\$objをjsonのファイルに書き出している.
38行目以下のコードに関してはフォームの送信先がphp5.phpになっていること以外はソースコード4[php4.php]と共通である.

\lstinputlisting[caption=PHP5.php,label=pg:k5-1s]{src/php5.php}

\subsection{実行結果}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=10cm]{7.png}
  }
  \caption{ソースコード5の実行結果[1]}
\label{fig:fig9}
\end{figure}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=10cm]{8.png}
  }
  \caption{ソースコード5の実行結果[2]}
\label{fig:fig10}
\end{figure}


\figref{fig:fig9}はphp5.phpページを開いた時の初期画面である.jsonが読み込まれていることがわかる.
\figref{fig:fig10}で永続的にデータが保存されていることが確認できる.

%=================================================================================
\newpage

\section{応用課題1}

\subsection{問題}

  セッションを用いて,ユーザーがアクセスしてきた回数をページに表示するプログラム
  php-advance-1.phpを作成せよ.
  ただし,初めてのアクセスの際には回数の代わりに「初めての訪問です」というようなメッセージを表示するようにせよ.

\subsection{ソースコード}

ソースコード6のソース2行目でセッションを開始する session\_start() をコールした.
17行目で今までに訪問したことが無い場合,すなわち変数\$\_SESSION["visited"]が無い場合,初めての訪問です! と表示するようになっている.また,表示したのち\$\_SESSION["visited"]に1を代入する.
対して20行目からは,訪問したことがある場合,すなわち\$\_SESSION["visited"]が1以上の場合は変数 \$visited に　\$\_SESSION["visited"]の値を代入する.
22行目で訪問回数を増加させている.\$visitedには訪問回数が格納されていることになるので24行目では \$visited.　'回目'とすることでセッションの回数を表示することができる.

\lstinputlisting[caption=php-advance-1.php,label=pg:k6-1s]{src/php-advance-1.php}

\subsection{実行結果}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=6cm]{ad1.png}
  }
  \caption{ソースコード6の実行結果[1]}
\label{fig:ad1}
\end{figure}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=6cm]{ad2.png}
  }
  \caption{ソースコード6の実行結果[2]}
\label{fig:ad2}
\end{figure}


\figref{fig:ad1}はphp-advance-1.phpページを開いた時の初期画面である.初めての訪問と出る.
\figref{fig:ad2}では \$visited　にセッション回数が保存されているのでn(セッション回数)回目の訪問と出る.50回までは表示されることを検証した.

%=================================================================================

\section{応用課題2}

\subsection{問題}


  ファイルを選択できるフォームを作成し,選択されたファイルを保存するプログラム
php-advance-2.phpを作成せよ.
ただし,保存先はプログラムが保存されているディレクトリと同一のディレクトリで構わ
ず,ファイルが選択されずにフォームが送信された場合にはエラー表示をするようにせよ.

\subsection{ソースコード}

  ソースコード7の12行目でスーパーグローバル変数の\$\_FILE['fname']でアップロードしたファイルの名前を取得する.
  14行目で一時的なファイルの名前を定義する.15行目でアップロードが完了して実際に保存されるファイルの名前を定義する.
  20行目でアップロードファイルが送信された際の動作を定義している.
  一時的な場所からファイルがドキュメントルートに保存された場合,”Successful:ファイルのアップロードに成功しました.”と表示される.
  もし何も送信されなかった場合は”Error: ファイルが指定されていません”と表示される.

\lstinputlisting[caption=php-advance-2.php,label=pg:k6-1s]{src/php-advance-2.php}

\subsection{実行結果}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=4cm]{ad3.png}
  }
  \caption{ソースコード7の実行結果[1]}
\label{fig:ad3}
\end{figure}

\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=4cm]{ad4.png}
  }
  \caption{ソースコード7の実行結果[2]}
\label{fig:ad4}
\end{figure}
\begin{figure}[H]
  \centering
  \fbox{
  \includegraphics[width=4cm]{ad5.png}
  }
  \caption{ソースコード7の実行結果[3]}
\label{fig:ad5}
\end{figure}

\figref{fig:ad3}はphp-advance-1.phpページを開いた時の初期画面である..
\figref{fig:ad4}はファイルの送信に成功した時の表示である.
\figref{fig:ad5}はファイルの送信に失敗した時の表示である.

\begin{thebibliography}{4}
  \bibitem{PHP} PHPマニュアル http://php.net/manual/ja/
  \bibitem{HTML} HTML5リファレンス http://www.htmq.com/html5/
\end{thebibliography}

\end{document}
